# 分块上传功能模块解析
该功能尚未整合到Html前端页面，只是使用`test_mpupload.go`模拟前端单独测试


`mpupload.go`实现服务端功能
`test_mpupload.go`模拟客户端 
`Redis`作为缓存存储分块上传的状态信息，
其中创建一个键名为`UploadID`的哈希表，哈希表中存储的状态信息有`chunkcount`（文件分块的总数），`filehash`，`filesize`，`chkidx_<chunkIndex>`（每个分块的索引ID）
## 模块概述
分块上传功能模块主要用于处理大文件的上传需求，通过将文件分割成多个小块并逐块上传，解决了大文件上传过程中可能出现的网络不稳定、传输中断等问题。该模块的主要功能包括：

1. 初始化分块上传。
2. 上传文件分块。
3. 合并分块并完成上传。

过程：
### 分块上传的交互过程
客户端通过`resp, err := http.PostForm(请求内容以及携带的值信息)`像服务端发送请求

服务端返回的结果存储在`resp.Body`中供客户端读取

1. **初始化分块上传**  
   客户端发送初始化请求到服务端 →  
   服务端解析请求参数，生成 `UploadID` 和分块信息 →  
   服务端将分块信息存储到 Redis（如分块总数、文件哈希值、文件大小等） →  
   服务端返回 `UploadID` 和分块信息给客户端。

2. **上传文件分块**  
   客户端根据返回的信息将文件进行分块划分并生成`index`(都在`multipartUpload`内完成)之后发送分块上传请求到服务端 →  
   服务端解析请求参数，生成分块文件存储路径并写入分块数据 →  
   服务端在 Redis 中更新分块上传状态（标记分块已上传） →  
   服务端返回上传结果给客户端 →  
   客户端继续上传下一个分块，直到所有分块上传完成。

3. **合并分块并完成上传**  
   客户端通过 `multipartUpload` 函数中的`ch`通道机制确认收到所有分块上传完成的结果后开始发送合并请求到服务端 →  
   服务端解析请求参数，查询 Redis 中的分块状态，验证所有分块是否上传完成 →  
   服务端调用 `mergeChunks` 函数合并分块文件为完整文件 →  
   服务端删除分块文件并更新数据库（如用户文件表和唯一文件表） →  
   服务端删除 Redis 中的分块状态，释放内存 →  
   服务端返回合并结果给客户端。
--------
### （代码还未实现）分块上传的断点续传过程 
当传到一半因某些情况上传终止之后，用户再次发起上传请求。
1. **初始化分块上传**  
   同分块上传

2. **检查已上传分块状态**  
   客户端发送查询请求到服务端，获取已上传分块的状态 →  
   服务端从 Redis 中查询 `chkidx_<index>` 字段，返回已上传的分块索引列表给客户端 →  
   客户端根据返回的分块状态，跳过已上传的分块，继续上传未完成的分块。

3. **上传未完成的分块**  
   同分块上传

4. **合并分块并完成上传**  
  同分块上传


#### 断点续传的关键点
- **状态管理**：通过 Redis 存储每个分块的上传状态（`chkidx_<index>`），确保可以查询哪些分块已上传。
- **跳过已上传分块**：客户端根据服务端返回的分块状态，跳过已完成的分块，避免重复上传。
- **分块合并**：在所有分块上传完成后，服务端合并分块文件，完成整个上传流程。

-----------

## `mpupload.go`服务端功能解析
## 核心结构
模块中定义了一个核心结构体 `MultipartUploadInfo`，用于存储分块上传的相关信息：

- `FileHash`：文件的哈希值，用于唯一标识文件。
- `FileSize`：文件的总大小。
- `UploadID`：上传任务的唯一标识符。
- `ChunkSize`：每个分块的大小。
- `ChunkCount`：分块的总数。





### 1. 初始化分块上传
**函数：`InitialMultipartUploadHandler`**
- 解析用户请求参数，包括用户名、文件哈希值和文件大小。
- 通过 Redis 连接池获取一个连接。
- 生成分块上传的初始化信息，包括分块大小（默认 5MB）和分块总数。
- 将初始化信息存储到 Redis 中，键名格式为 `MP_<UploadID>`，存储内容包括分块总数、文件哈希值和文件大小。
- 返回初始化信息（如 `UploadID` 和分块信息）给客户端。

### 2. 上传文件分块
**函数：`UploadPartHandler`**
- 解析用户请求参数，包括 `uploadid` 和分块索引 `index`。
- 通过 Redis 连接池获取一个连接。
- 根据 `uploadid` 和分块索引生成分块文件的存储路径，并创建必要的目录。
- 打开文件句柄，将分块数据写入文件，支持分块数据流式写入。
- 更新 Redis 中的分块上传状态，键名格式为 `chkidx_<index>`，值为 `1` 表示该分块已上传。
- 返回上传结果（成功或失败）给客户端。

### 3. 合并分块并完成上传
**函数：`CompleteUploadHandler`**
- 解析用户请求参数，包括 `uploadid`、用户名、文件哈希值、文件大小和文件名。
- 通过 Redis 连接池获取一个连接。
- 查询 Redis 中的分块上传状态，验证所有分块是否上传完成。
- 调用 `mergeChunks` 函数合并分块文件为完整文件，合并完成后删除分块文件以节省存储空间。
- 更新数据库，包括唯一文件表和用户文件表，记录文件上传信息。
- 返回处理结果（成功或失败）给客户端。

**函数：`mergeChunks`**
- 按顺序读取所有分块文件并将其内容写入目标文件。
- 合并完成后删除分块文件以节省存储空间。
- 如果在合并过程中发生错误，返回错误信息。