# 这些微服务部署在K8S上，用户访问微服务如何鉴权认证？微服务之间又如何防止越权访问对方服务的数据？

## 用户访问微服务如何鉴权认证：

**在设计成微服务之前**,Gin框架路由中使用Gin框架的use方法加入一个拦截器中间件，这个拦截器将调动token验证函数来验证Sha1加密的信息是否合法。



### 微服务
account微服务负责账号的验证，用户的流量同一先经过API网关微服务，API网关微服务再调用account微服务的token验证函数。

#### 可使用JWT改进：
可以使用JWT (JSON Web Token)：JWT 用于承载用户的身份信息。用户登录后，认证服务（如 Auth 服务）会生成 JWT 并返回给用户。之后，用户每次请求微服务时，会在请求头中携带 JWT，微服务会对 JWT 进行解码和验证，确保用户身份合法。


##### 设计 JWT 流程
**a. 用户初次登录**
**用户登录请求**：用户通过 API 网关发送登录请求，携带用户名和密码。

**API 网关转发请求**：API 网关将登录请求转发给 account 微服务，进行用户名和密码的验证。

**生成 JWT**：如果验证成功，account 微服务 会生成一个 JWT，JWT 中包含用户的身份信息（如用户 ID、角色、权限等），并使用服务器的私钥进行签名。

**返回 JWT**：account 微服务 将生成的 JWT 返回给 API 网关，API 网关再将 JWT 返回给用户。

**b. 用户访问 API 服务**
**携带 JWT 进行请求**：用户在后续访问 API 时，将 JWT 作为请求头的一部分传递给 API 网关，通常是使用 Authorization 头，格式为 Bearer <JWT>。

**API 网关验证 JWT**：API 网关收到请求后，首先检查 JWT 是否存在。如果 JWT 存在，API 网关会通过调用 account 微服务 的验证函数，使用公钥验证 JWT 的签名是否有效。

`如果 JWT 合法且没有过期`，API 网关会将用户的身份信息（如用户 ID、角色等）解码并附加到请求的上下文中，转发给后端服务。

`如果 JWT 无效或过期`，API 网关会返回相应的错误响应，如 401 Unauthorized。




##  微服务之间防止越权访问

### 可以使用k8s的RBAC和网络策略 (Network Policies)来进行权限管理：

**RBAC控制了 API 和资源的访问权限**：每个微服务关联一个服务账户 (ServiceAccount)，使用使用 Role 和 RoleBinding 来定义每个服务账户能够访问的资源范围。Role就是一组权限的集合。

网络策略 (Network Policies)限制服务间的网络访问


### 可以使用服务网格（如 Istio, Linkerd）：
通过 Istio 等服务网格，可以为微服务之间的通信添加身份验证、访问控制、加密等安全措施，确保服务之间的请求只能由有权限的服务发起。
