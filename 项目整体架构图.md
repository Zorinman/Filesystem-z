# 文件存储系统 - 整体架构图

## 1. 系统架构总览

```mermaid
graph TB
    subgraph "用户层"
        User[用户/客户端<br/>浏览器/移动应用]
    end
    
    subgraph "Kubernetes集群"
        subgraph "Ingress层"
            Ingress[Traefik Ingress<br/>apigw.* / upload.* / download.*]
        end
        
        subgraph "微服务层"
            APIGateway[API网关<br/>apigw:8080<br/>HTTP]
            Upload[Upload服务<br/>upload:28080<br/>HTTP]
            Download[Download服务<br/>download:38080<br/>HTTP]
            Account[Account服务<br/>account:8080<br/>gRPC]
            DBProxy[DBProxy服务<br/>数据库代理/ORM<br/>gRPC]
        end
        
        subgraph "数据层"
            MySQL[(MySQL数据库<br/>tbl_user<br/>tbl_file<br/>tbl_user_token)]
            Redis[(Redis缓存<br/>分块上传)]
            RabbitMQ[RabbitMQ<br/>异步上传队列]
        end
        
        subgraph "存储层"
            LocalStorage[本地存储]
            OSS[OSS对象存储]
            Ceph[Ceph存储]
        end
    end
    
    User -->|HTTP/HTTPS| Ingress
    Ingress --> APIGateway
    Ingress --> Upload
    Ingress --> Download
    
    APIGateway -->|gRPC| Account
    Upload -->|gRPC| DBProxy
    Download -->|gRPC| DBProxy
    Account -->|gRPC| DBProxy
    
    DBProxy --> MySQL
    
    Upload --> Redis
    Upload --> RabbitMQ
    Upload --> LocalStorage
    Upload --> OSS
    Upload --> Ceph
    
    Download --> LocalStorage
    Download --> OSS
    Download --> Ceph
    
    style User fill:#e1f5ff
    style Ingress fill:#fff4e6
    style APIGateway fill:#e8f5e9
    style Upload fill:#e8f5e9
    style Download fill:#e8f5e9
    style Account fill:#e8f5e9
    style DBProxy fill:#f3e5f5
    style MySQL fill:#ffebee
    style Redis fill:#ffebee
    style RabbitMQ fill:#ffebee
```

---

## 2. 用户登录流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant APIGateway as API网关
    participant Account as Account服务
    participant DBProxy as DBProxy
    participant MySQL as MySQL数据库
    
    User->>APIGateway: POST /user/signin<br/>(username, password)
    APIGateway->>Account: gRPC: Signin()
    Account->>DBProxy: gRPC: UserSignin()
    DBProxy->>MySQL: 验证用户名密码
    MySQL-->>DBProxy: 验证结果
    DBProxy-->>Account: 验证成功
    Account->>Account: 生成Token<br/>MD5(username+timestamp+salt)
    Account->>DBProxy: gRPC: UpdateToken()
    DBProxy->>MySQL: 存储Token到tbl_user_token
    MySQL-->>DBProxy: 存储成功
    DBProxy-->>Account: 成功
    Account-->>APIGateway: 返回Token
    APIGateway-->>User: 返回Token + 上传/下载入口地址
```

---

## 3. 文件上传流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant Upload as Upload服务
    participant DBProxy as DBProxy
    participant MySQL as MySQL
    participant Redis as Redis
    participant MQ as RabbitMQ
    participant Storage as 存储层
    
    User->>Upload: POST /file/upload<br/>(file, username, token)
    
    alt 秒传检查
        Upload->>DBProxy: 查询文件hash是否存在
        DBProxy->>MySQL: SELECT from tbl_file
        MySQL-->>DBProxy: 文件已存在
        DBProxy-->>Upload: 返回文件信息
        Upload-->>User: 秒传成功
    else 普通上传
        Upload->>Storage: 保存文件(本地/OSS/Ceph)
        Storage-->>Upload: 保存成功
        Upload->>DBProxy: 保存文件元数据
        DBProxy->>MySQL: INSERT into tbl_file
        MySQL-->>DBProxy: 成功
        DBProxy-->>Upload: 成功
        Upload-->>User: 上传成功
    else 分块上传
        Upload->>Redis: 缓存分块信息
        Upload->>MQ: 发送异步任务
        Upload-->>User: 分块上传中
        MQ->>Storage: 异步合并分块
        Storage->>DBProxy: 保存元数据
        DBProxy->>MySQL: INSERT into tbl_file
    end
```

---

## 4. 文件下载流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant Download as Download服务
    participant DBProxy as DBProxy
    participant MySQL as MySQL
    participant Storage as 存储层
    
    User->>Download: GET /file/download<br/>(filehash, username, token)
    Download->>DBProxy: gRPC: GetFileMeta(filehash)
    DBProxy->>MySQL: SELECT from tbl_file
    MySQL-->>DBProxy: 返回文件元信息
    DBProxy-->>Download: 文件路径、大小等信息
    
    alt 本地/Ceph存储
        Download->>Storage: 读取文件
        Storage-->>Download: 文件流
        Download-->>User: 返回文件流
    else OSS存储
        Download->>Storage: 生成签名URL
        Storage-->>Download: 签名URL
        Download-->>User: 重定向到OSS URL
    end
```

---

## 5. 微服务交互关系图

```mermaid
graph LR
    subgraph "前端入口"
        APIGateway[API网关<br/>协议转换<br/>路由分发]
    end
    
    subgraph "业务服务"
        Account[Account服务<br/>用户管理<br/>Token生成]
        Upload[Upload服务<br/>文件上传<br/>秒传/分块]
        Download[Download服务<br/>文件下载<br/>断点续传]
    end
    
    subgraph "基础服务"
        DBProxy[DBProxy服务<br/>数据库代理<br/>统一ORM]
    end
    
    APIGateway -->|gRPC| Account
    APIGateway -.->|动态获取入口| Upload
    APIGateway -.->|动态获取入口| Download
    
    Upload -->|gRPC| DBProxy
    Download -->|gRPC| DBProxy
    Account -->|gRPC| DBProxy
    
    style APIGateway fill:#e8f5e9
    style Account fill:#fff4e6
    style Upload fill:#fff4e6
    style Download fill:#fff4e6
    style DBProxy fill:#f3e5f5
```

---

## 6. 技术栈架构

```mermaid
graph TB
    subgraph "应用层"
        App[Gin框架 HTTP路由<br/>gRPC 微服务通信<br/>Protocol Buffers]
    end
    
    subgraph "微服务框架层"
        Framework[go-micro<br/>服务注册/发现<br/>负载均衡<br/>RPC调用]
    end
    
    subgraph "编排层"
        K8s[Kubernetes<br/>容器编排<br/>服务发现<br/>Traefik Ingress<br/>RBAC权限控制]
    end
    
    subgraph "容器层"
        Docker[Docker<br/>容器化部署<br/>镜像管理]
    end
    
    App --> Framework
    Framework --> K8s
    K8s --> Docker
    
    style App fill:#e3f2fd
    style Framework fill:#e8f5e9
    style K8s fill:#fff3e0
    style Docker fill:#fce4ec
```

---

## 7. Kubernetes部署架构

```mermaid
graph TB
    subgraph "Kubernetes集群"
        subgraph "Ingress Controller"
            Traefik[Traefik Ingress<br/>apigw.fileserver.com<br/>upload.fileserver.com<br/>download.fileserver.com]
        end
        
        subgraph "Namespace: default"
            subgraph "Services"
                SvcAPIGW[svc-apigw:8080]
                SvcAccount[svc-account:8080]
                SvcUpload[svc-upload:28080]
                SvcDownload[svc-download:38080]
                SvcDBProxy[svc-dbproxy]
            end
            
            subgraph "Deployments"
                PodAPIGW[apigw Pod<br/>Replicas: 1]
                PodAccount[account Pod<br/>Replicas: 1]
                PodUpload[upload Pod<br/>Replicas: 1]
                PodDownload[download Pod<br/>Replicas: 1]
                PodDBProxy[dbproxy Pod<br/>Replicas: 1]
            end
            
            subgraph "RBAC"
                SA[ServiceAccount: default]
                Role[Role: pod-viewer-role]
                RoleBinding[RoleBinding]
            end
        end
        
        subgraph "Service Discovery"
            K8sAPI[Kubernetes API<br/>--registry=kubernetes]
        end
    end
    
    Traefik --> SvcAPIGW
    Traefik --> SvcUpload
    Traefik --> SvcDownload
    
    SvcAPIGW --> PodAPIGW
    SvcAccount --> PodAccount
    SvcUpload --> PodUpload
    SvcDownload --> PodDownload
    SvcDBProxy --> PodDBProxy
    
    PodAPIGW -.->|服务发现| K8sAPI
    PodAccount -.->|服务发现| K8sAPI
    PodUpload -.->|服务发现| K8sAPI
    PodDownload -.->|服务发现| K8sAPI
    PodDBProxy -.->|服务发现| K8sAPI
    
    SA --> Role
    Role --> RoleBinding
    RoleBinding -.->|授权| PodAPIGW
    
    style Traefik fill:#fff4e6
    style K8sAPI fill:#e8f5e9
```

---

## 8. 核心模块说明

| 模块 | 端口 | 协议 | 职责 |
|------|------|------|------|
| **API网关** | 8080 | HTTP | 统一入口、协议转换、路由分发 |
| **Account** | 8080 | gRPC | 用户注册/登录/Token管理 |
| **Upload** | 28080 | HTTP | 文件上传、秒传、分块上传 |
| **Download** | 38080 | HTTP | 文件下载、断点续传 |
| **DBProxy** | - | gRPC | 数据库操作统一代理 |
| **Transfer** | - | - | 文件迁移/备份（未完成） |

---

## 9. 关键特性

### ✅ 已实现
- 微服务架构（6个服务模块）
- gRPC服务间通信
- Kubernetes容器编排
- 多存储后端支持（本地/OSS/Ceph）
- 分块上传（Redis缓存）
- 异步上传（RabbitMQ）
- 基础RBAC权限控制

### ⚠️ 待完善
- Token验证逻辑未实现
- 服务间认证缺失
- Network Policy未配置
- 服务网格未引入
- Transfer服务未完成

---

## 10. 架构优势

1. **高可扩展性** - 微服务独立部署，可按需扩容
2. **高可用性** - Kubernetes自动故障恢复
3. **存储灵活** - 支持多种存储后端
4. **性能优化** - Redis缓存 + RabbitMQ异步处理
5. **协议适配** - API网关统一HTTP/gRPC转换

---

## 11. 架构演进建议

**当前阶段**: 基础微服务架构 ✅

**下一阶段**: 
- 完善认证鉴权（JWT + Service Token）
- 添加Network Policy
- 引入服务网格（Istio）
- 实现可观测性（日志/监控/追踪）
